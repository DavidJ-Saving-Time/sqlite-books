<!DOCTYPE html>
<html>
<head>
    <title>AJAX Fuzzy Text Search</title>

    
        <link id="themeStylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
        
</head>
<body class="bg-light py-4">
<div class="container">
    <h1 class="mb-4 text-primary"><i class="fas fa-search"></i> Search Large Text Files</h1>

    
<div id="queueStatus" class="alert alert-info mt-4" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <strong>Queue:</strong>
            <span id="queueCount">0</span> item(s),
            <span id="queueState">Paused</span>
        </div>
        <div>
            <button class="btn btn-sm btn-success me-2" onclick="startQueue()"><i class="fas fa-play"></i> Start</button>
            <button class="btn btn-sm btn-warning me-2" onclick="stopQueue()"><i class="fas fa-pause"></i> Pause</button>
            <button class="btn btn-sm btn-danger" onclick="clearQueue()"><i class="fas fa-trash"></i> Clear</button>
        </div>
    </div>
    <ul id="queueList" class="list-group list-group-flush small">
        <!-- Live items show here -->
    </ul>
</div>
    
    <form id="searchForm" class="input-group mb-4">
        <input type="text" id="query" class="form-control" placeholder="e.g. John Doe" required>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-search"></i> Search
        </button>
<div class="form-check ms-3 align-self-center">
  <input class="form-check-input" type="checkbox" id="requireAllWords">
  <label class="form-check-label" for="requireAllWords">Must contain all words</label>
</div>
    </form>

    <div id="recent" class="mb-4">
        <h6 class="text-muted">Recent searches:</h6>
        <div id="recentList" class="d-flex flex-wrap gap-2">
            <!-- Recent search pills get added here -->
        </div>
    </div>

    <div id="results">
        <!-- Results will be dynamically inserted here -->
    </div>
</div>

<script>
const API_BASE = "https://node2.nilla.local";
const form = document.getElementById('searchForm');
const queryInput = document.getElementById('query');
const resultsDiv = document.getElementById('results');
const recentList = document.getElementById('recentList');

let queue = [];
let isQueueRunning = false;
let queueTimer = null;

const queueStatus = document.getElementById('queueStatus');
const queueCount = document.getElementById('queueCount');
const queueState = document.getElementById('queueState');
const queueList = document.getElementById('queueList');

function updateQueueDisplay() {
    queueCount.textContent = queue.length;
    queueState.textContent = isQueueRunning ? "Running" : "Paused";
    queueStatus.style.display = queue.length > 0 ? 'block' : 'none';

    queueList.innerHTML = '';
    queue.forEach((item) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';

        const secondsLeft = Math.max(0, Math.floor((item.executeAt - Date.now()) / 1000));

        li.innerHTML = `
            <div class="flex-grow-1">
                <strong>${item.cmd}</strong><br>
                <small class="text-muted">
                    Runs in <span class="countdown" data-id="${item.id}">${secondsLeft}</span> seconds
                </small>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="removeFromQueueById('${item.id}')">
                <i class="fas fa-times"></i>
            </button>
        `;

        queueList.appendChild(li);
    });
}

function removeFromQueueById(id) {
    queue = queue.filter(item => item.id !== id);
    updateQueueDisplay();
}

function getRandomInterval() {
    return Math.floor(Math.random() * (75 - 35 + 1) + 35) * 1000;
}

function addToQueue(cmd) {
    const lastExecuteAt = queue.length > 0
        ? queue[queue.length - 1].executeAt
        : Date.now();

    const delay = getRandomInterval();
    const executeAt = lastExecuteAt + delay;

    queue.push({
        id: crypto.randomUUID(),
        cmd,
        executeAt
    });

    updateQueueDisplay();
}

function startQueue() {
    if (isQueueRunning || queue.length === 0) return;

    isQueueRunning = true;
    queueState.textContent = 'Running';

    const processNext = () => {
        if (!isQueueRunning || queue.length === 0) {
            stopQueue();
            return;
        }

        const now = Date.now();
        const nextItem = queue[0];

        const delay = nextItem.executeAt - now;
        if (delay > 0) {
            queueTimer = setTimeout(processNext, delay);
            return;
        }

        const cmd = queue.shift().cmd;
        updateQueueDisplay();

        fetch(`${API_BASE}/request-file?cmd=${encodeURIComponent(cmd)}`)
            .then(res => res.json())
            .then(data => {
                console.log("Queued command sent:", cmd, data.status || data.error);
            })
            .catch(err => {
                console.error("Queue error:", err);
            });

        queueTimer = setTimeout(processNext, 1000); // slight delay between items
    };

    processNext();
}

function stopQueue() {
    isQueueRunning = false;
    if (queueTimer) clearTimeout(queueTimer);
    queueTimer = null;
    updateQueueDisplay();
}

function clearQueue() {
    queue = [];
    stopQueue();
    updateQueueDisplay();
}

// Recent search functionality
const saveRecentSearch = (term) => {
    let recents = JSON.parse(localStorage.getItem('recentSearches') || '[]');
    recents = recents.filter(t => t !== term);
    recents.unshift(term);
    recents = recents.slice(0, 10);
    localStorage.setItem('recentSearches', JSON.stringify(recents));
    renderRecentSearches();
};

const renderRecentSearches = () => {
    let recents = JSON.parse(localStorage.getItem('recentSearches') || '[]');
    recentList.innerHTML = '';
    recents.forEach(term => {
        const span = document.createElement('span');
        span.className = 'badge rounded-pill bg-secondary text-light px-3 py-2';
        span.textContent = term;
        span.style.cursor = 'pointer';
        span.onclick = () => {
            queryInput.value = term;
            form.dispatchEvent(new Event('submit'));
        };
        recentList.appendChild(span);
    });
};

// Search form submit
form.addEventListener('submit', function(e) {
    e.preventDefault();
    const query = queryInput.value.trim();
    if (!query) return;

    saveRecentSearch(query);
    resultsDiv.innerHTML = `
        <div class="text-muted"><i class="fas fa-spinner fa-spin"></i> Searching...</div>
    `;

fetch('irc_search.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
        q: query,
        requireAllWords: document.getElementById('requireAllWords').checked ? '1' : '0'
    })
})
    .then(res => res.json())
    .then(data => {
        resultsDiv.innerHTML = '';

        if (data.matches.length === 0) {
            resultsDiv.innerHTML = `<div class="alert alert-warning">No matches found.</div>`;
            return;
        }

        const countMsg = `<p class="text-muted">Found ${data.matches.length} match(es)</p>`;
        resultsDiv.insertAdjacentHTML('beforeend', countMsg);

        data.matches.forEach(line => {
            const cleanText = line.replace(/(::HASH::|::INFO::).*/i, '').replace(/<[^>]+>/g, '').trim();

            const card = document.createElement('div');
            card.className = 'card mb-3 shadow-sm';

            const cardBody = document.createElement('div');
            cardBody.className = 'card-body d-flex justify-content-between align-items-start';

            const text = document.createElement('div');
            text.innerHTML = line;

            const button = document.createElement('button');
            button.className = 'btn btn-sm btn-outline-primary';
            button.innerHTML = `<i class="fas fa-download"></i> Request File`;
            button.onclick = async () => {
                try {
                    const res = await fetch(`${API_BASE}/request-file?cmd=${encodeURIComponent(cleanText)}`);
                    const data = await res.json();
                    alert(data.status || data.error || "No response");
                } catch (e) {
                    alert("Error sending request.");
                    console.error("Error:", e);
                }
            };

            const queueBtn = document.createElement('button');
            queueBtn.className = 'btn btn-sm btn-outline-secondary ms-2';
            queueBtn.innerHTML = `<i class="fas fa-clock"></i> Queue`;
            queueBtn.onclick = () => {
                addToQueue(cleanText);
                alert("Command added to queue.");
            };

            cardBody.appendChild(text);
            cardBody.appendChild(button);
            cardBody.appendChild(queueBtn);
            card.appendChild(cardBody);
            resultsDiv.appendChild(card);
        });
    })
    .catch(err => {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${err}</div>`;
    });
});

// Live countdown update
setInterval(() => {
    if (!isQueueRunning) return; // â›” Don't update countdown if paused

    document.querySelectorAll('.countdown').forEach(span => {
        const id = span.dataset.id;
        const item = queue.find(q => q.id === id);
        if (item) {
            const timeLeft = Math.max(0, Math.floor((item.executeAt - Date.now()) / 1000));
            span.textContent = timeLeft;
        }
    });
}, 1000);

renderRecentSearches();
</script>

</body>

</html>
