diff --git a/add_physical_book.php b/add_physical_book.php
index 13211a82f5af3d66ae1621060d1b4b736a3ced29..7a33cd8d0c9e99cab23d77aac134db8ec7498ec5 100755
--- a/add_physical_book.php
+++ b/add_physical_book.php
@@ -227,50 +227,51 @@ if ($_SERVER['REQUEST_METHOD'] === 'POST') {
                    $tagsXml .
                    "    <dc:language>" . htmlspecialchars($languageCode) . "</dc:language>\n" .
                    "    <dc:identifier opf:scheme=\"uuid\">$uuid</dc:identifier>\n" .
                    $isbnXml .
                    "    <meta name=\"calibre:timestamp\" content=\"$timestamp+00:00\"/>\n" .
                    "  </metadata>\n</package>";
             file_put_contents($fullBookFolder . '/metadata.opf', $opf);
 
             $pdo->commit();
             $message = 'Book added successfully.';
         } catch (Exception $e) {
             $pdo->rollBack();
             $errors[] = $e->getMessage();
         }
     }
 }
 ?>
 
 
 
 <!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">
+    <link rel="manifest" href="manifest.json">
     <title>Add Book</title>
     <link id="themeStylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
     <script src="js/theme.js"></script>
     <style>
         .file-upload-highlight {
             border: 2px dashed #6c757d;
             padding: 2rem;
             text-align: center;
             cursor: pointer;
             transition: background-color 0.2s ease;
         }
         .file-upload-highlight:hover {
             background-color: #f8f9fa;
         }
     </style>
 </head>
 <body>
 <?php include 'navbar_other.php'; ?>
 <div class="container my-4">
     <h1 class="mb-4 text-center">Add a New Book</h1>
     
     <?php if ($message): ?>
         <div class="alert alert-success"><?= htmlspecialchars($message) ?></div>
     <?php elseif ($errors): ?>
         <div class="alert alert-danger"><?= htmlspecialchars(implode(' ', $errors)) ?></div>
@@ -330,28 +331,29 @@ fileInput.addEventListener('change', () => {
     if (!fileInput.files.length) return;
 
     // Show progress bar
     metadataProgress.style.display = 'block';
 
     const fd = new FormData();
     fd.append('file', fileInput.files[0]);
     fetch('ebook_meta.php', { method: 'POST', body: fd })
         .then(r => r.json())
         .then(data => {
             if (data.title && !titleInput.value) titleInput.value = data.title;
             if (data.authors && !authorsInput.value) {
                 authorsInput.value = Array.isArray(data.authors)
                     ? data.authors.join(', ')
                     : String(data.authors).replace(/ and /g, ', ');
             }
         })
         .catch(() => {})
         .finally(() => {
             // Hide progress and show book details
             metadataProgress.style.display = 'none';
             bookDetails.style.display = 'block';
         });
 });
 </script>
+<script src="js/pwa.js"></script>
 </body>
 </html>
 
diff --git a/annas_results.php b/annas_results.php
index b874665f44b8a51f33740fa05cad7e684637f226..ff3367d7cc67531c40c5c440737b219cdb6bb9dd 100644
--- a/annas_results.php
+++ b/annas_results.php
@@ -1,43 +1,44 @@
 <?php
 require_once 'db.php';
 requireLogin();
 require_once 'annas_archive.php';
 
 $search = isset($_GET['search']) ? trim((string)$_GET['search']) : '';
 $sort = $_GET['sort'] ?? 'author_series';
 $source = 'annas';
 $books = [];
 if ($search !== '') {
     $books = search_annas_archive($search);
 }
 ?>
 <!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">
+    <link rel="manifest" href="manifest.json">
     <title>Anna's Archive Results</title>
     <link id="themeStylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
     <script src="js/theme.js"></script>
     <script src="js/search.js"></script>
 </head>
 <body class="pt-5">
 <?php include "navbar_other.php"; ?>
 <div class="container my-4">
     <h1 class="mb-4">Anna's Archive Results</h1>
     <table class="table table-striped">
         <thead>
             <tr>
                 <th>Cover</th>
                 <th class="title-col">Title</th>
                 <th>Author(s)</th>
                 <th>Genre</th>
                 <th>Year</th>
                 <th>Size</th>
                 <th>Actions</th>
             </tr>
         </thead>
         <tbody>
         <?php foreach ($books as $book): ?>
             <tr>
                 <td>
@@ -62,27 +63,28 @@ if ($search !== '') {
                 <td><?= $book['size'] !== '' ? htmlspecialchars($book['size']) : '&mdash;' ?></td>
                 <td>
                     <?php if (!empty($book['md5'])): ?>
                         <button type="button" class="btn btn-sm btn-success annas-download" data-md5="<?= htmlspecialchars($book['md5']) ?>">
                             Download<?php if (!empty($book['format'])): ?> <?= htmlspecialchars(strtoupper($book['format'])) ?><?php endif; ?>
                         </button>
                     <?php else: ?>
                         &mdash;
                     <?php endif; ?>
                     <button type="button" class="btn btn-sm btn-primary ms-1 annas-add"
                             data-title="<?= htmlspecialchars($book['title'], ENT_QUOTES) ?>"
                             data-authors="<?= htmlspecialchars($book['author'], ENT_QUOTES) ?>"
                             data-thumbnail="<?= htmlspecialchars($book['imgUrl'], ENT_QUOTES) ?>"
                             data-description="">
                         Add to Library
                     </button>
                     <span class="annas-add-result ms-1"></span>
                 </td>
             </tr>
         <?php endforeach; ?>
         </tbody>
     </table>
 </div>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
 <script src="js/annas_results.js"></script>
+<script src="js/pwa.js"></script>
 </body>
 </html>
diff --git a/book.php b/book.php
index 68f00b83888b1d546c07ff4f367a92b9c7cde45f..1fe0899c58326aaddee6aaec3604c2e33ef7b828 100644
--- a/book.php
+++ b/book.php
@@ -313,50 +313,51 @@ try {
     $notesStmt->execute([$id]);
     $notes = $notesStmt->fetchColumn() ?: '';
 } catch (PDOException $e) {
     $notes = '';
 }
 
 $missingFile = !bookHasFile($book['path']);
 
 $libraryDirPath = getLibraryPath();
 if (!empty($book['path'])) {
     $libraryDirPath .= '/' . $book['path'];
 } else {
     $authorList = array_map('trim', explode(',', $book['authors'] ?? ''));
     $firstAuthor = $authorList[0] ?? '';
     $authorFolderName = safe_filename($firstAuthor . (count($authorList) > 1 ? ' et al.' : ''));
     $bookFolderName = safe_filename($book['title']) . ' (' . $book['id'] . ')';
     $libraryDirPath .= '/' . $authorFolderName . '/' . $bookFolderName;
 }
 $ebookFileRel = $missingFile ? '' : firstBookFile($book['path']);
 ?>
 <!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">
+    <link rel="manifest" href="manifest.json">
     <title><?= htmlspecialchars($book['title']) ?></title>
     <link id="themeStylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
     <script src="js/theme.js"></script>
     <style>
         #description { min-height: 200px; resize: vertical; }
     </style>
 </head>
 <body class="pt-5" data-book-id="<?= (int)$book['id'] ?>" data-search-query="<?= htmlspecialchars($book['title'] . ' ' . $book['authors'], ENT_QUOTES) ?>"<?php if($ebookFileRel): ?> data-ebook-file="<?= htmlspecialchars($ebookFileRel) ?>"<?php endif; ?><?php if(!empty($book['isbn'])): ?> data-isbn="<?= htmlspecialchars($book['isbn']) ?>"<?php endif; ?>>
 <?php include "navbar_other.php"; ?>
 <div class="container my-4">
     <a href="list_books.php" class="btn btn-secondary mb-3">
         <i class="fa-solid fa-arrow-left me-1"></i> Back to list
     </a>
 
     <!-- Book Title and Info -->
     <h1 class="mb-0">
         <?php if ($missingFile): ?>
             <i class="fa-solid fa-circle-exclamation text-danger me-1" title="File missing"></i>
         <?php endif; ?>
         <?= htmlspecialchars($book['title']) ?>
     </h1>
 
     <?php
         $formattedPubdate = '';
@@ -625,27 +626,28 @@ $ebookFileRel = $missingFile ? '' : firstBookFile($book['path']);
           <div class="modal-body">
             <div id="annasResults">Loading...</div>
           </div>
         </div>
       </div>
     </div>
 
     <!-- Google Books Metadata Modal -->
     <div class="modal fade" id="googleModal" tabindex="-1" aria-hidden="true">
       <div class="modal-dialog modal-lg">
         <div class="modal-content">
           <div class="modal-header">
             <h5 class="modal-title">Google Books Results</h5>
             <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
           </div>
           <div class="modal-body">
             <div id="googleResults">Loading...</div>
           </div>
         </div>
       </div>
     </div>
 </div>
     
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
 <script src="js/book.js"></script>
+<script src="js/pwa.js"></script>
 </body>
 </html>
diff --git a/fix_author_sort.php b/fix_author_sort.php
index b19da0174938da20660b5c702e8813ef9663e059..41edd33a2d2b4e2396cf3a0354a655d74880bda8 100644
--- a/fix_author_sort.php
+++ b/fix_author_sort.php
@@ -3,58 +3,60 @@ require_once 'db.php';
 requireLogin();
 $pdo = getDatabaseConnection();
 $message = '';
 if ($_SERVER['REQUEST_METHOD'] === 'POST') {
     $stmt = $pdo->query(
         "SELECT b.id, author_sort((SELECT a.name FROM authors a JOIN books_authors_link bal ON a.id=bal.author WHERE bal.book=b.id ORDER BY bal.id LIMIT 1)) AS expected\n         FROM books b\n         WHERE (b.author_sort IS NULL OR b.author_sort='' OR b.author_sort != author_sort((SELECT a.name FROM authors a JOIN books_authors_link bal ON a.id=bal.author WHERE bal.book=b.id ORDER BY bal.id LIMIT 1)))"
     );
     $count = 0;
     foreach ($stmt as $row) {
         $expected = trim($row['expected']);
         if ($expected === '') continue;
         $id = (int)$row['id'];
         $pdo->prepare('UPDATE books SET author_sort = :s WHERE id = :id')
             ->execute([':s' => $expected, ':id' => $id]);
         $count++;
     }
     $message = "$count book(s) updated.";
 }
 $query = "SELECT b.id, b.title, b.author_sort AS current,\n         author_sort((SELECT a.name FROM authors a JOIN books_authors_link bal\n                     ON a.id=bal.author WHERE bal.book=b.id ORDER BY bal.id LIMIT 1)) AS expected\n         FROM books b\n         WHERE (b.author_sort IS NULL OR b.author_sort='' OR\n                b.author_sort != author_sort((SELECT a.name FROM authors a JOIN books_authors_link bal\n                             ON a.id=bal.author WHERE bal.book=b.id ORDER BY bal.id LIMIT 1)))";
 $bad = $pdo->query($query)->fetchAll(PDO::FETCH_ASSOC);
 ?>
 <!doctype html>
 <html lang="en">
 <head>
   <meta charset="utf-8">
+  <link rel="manifest" href="manifest.json">
   <title>Fix Author Sort</title>
   <link id="themeStylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
   <script src="js/theme.js"></script>
 </head>
 <body class="container py-4">
   <h1 class="mb-4">Fix Author Sort</h1>
   <?php if ($message): ?>
   <div class="alert alert-info"><?= htmlspecialchars($message) ?></div>
   <?php endif; ?>
   <?php if ($bad): ?>
   <form method="post">
     <table class="table">
       <thead>
         <tr><th>ID</th><th>Title</th><th>Current</th><th>Expected</th></tr>
       </thead>
       <tbody>
       <?php foreach ($bad as $b): ?>
       <tr>
         <td><?= (int)$b['id'] ?></td>
         <td><?= htmlspecialchars($b['title']) ?></td>
         <td><?= htmlspecialchars($b['current']) ?></td>
         <td><?= htmlspecialchars($b['expected']) ?></td>
       </tr>
       <?php endforeach; ?>
       </tbody>
     </table>
     <button type="submit" class="btn btn-primary">Fix All</button>
   </form>
   <?php else: ?>
   <p>No books with bad author sort found.</p>
   <?php endif; ?>
+  <script src="js/pwa.js"></script>
 </body>
 </html>
diff --git a/google_results.php b/google_results.php
index fc70117f3884bdeef1302a5259f91e1fc13d6e41..724b3e6e9e109172dece29521b69d8053c7dab91 100644
--- a/google_results.php
+++ b/google_results.php
@@ -1,43 +1,44 @@
 <?php
 require_once 'db.php';
 requireLogin();
 require_once 'google_books.php';
 
 $search = isset($_GET['search']) ? trim((string)$_GET['search']) : '';
 $sort = $_GET['sort'] ?? 'author_series';
 $source = 'google';
 $books = [];
 if ($search !== '') {
     $books = search_google_books($search);
 }
 ?>
 <!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">
+    <link rel="manifest" href="manifest.json">
     <title>Google Books Results</title>
     <link id="themeStylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
     <script src="js/theme.js"></script>
     <script src="js/search.js"></script>
 </head>
 <body class="pt-5">
 <?php include "navbar_other.php"; ?>
 <div class="container">
     <!-- Header Row -->
     <div class="row fw-bold border-bottom pb-2 mb-3">
         <div class="col-md-3 col-12">Cover</div>
         <div class="col-md-5 col-12">Title</div>
         <div class="col-md-4 col-12">Author(s)</div>
     </div>
 
     <?php foreach ($books as $index => $book): ?>
         <?php $rowClass = $index % 2 === 0 ? 'bg-light' : 'bg-white'; ?>
         <div class="row mb-4 p-3 border rounded <?= $rowClass ?>">
             <!-- Cover -->
             <div class="col-md-3 col-12 text-center">
                 <?php if (!empty($book['imgUrl'])): ?>
                     <img src="<?= htmlspecialchars($book['imgUrl']) ?>" alt="Cover" class="img-fluid img-thumbnail">
                 <?php else: ?>
                     <span class="text-muted">&mdash;</span>
                 <?php endif; ?>
@@ -58,27 +59,28 @@ if ($search !== '') {
                 
                 <!-- Description -->
                 <div class="row">
                     <div class="col-12">
                         <p class="mb-0"><?= htmlspecialchars($book['description']) ?></p>
                     </div>
                 </div>
                 <div class="row mt-2">
                     <div class="col-12">
                         <button type="button" class="btn btn-sm btn-primary google-add"
                                 data-title="<?= htmlspecialchars($book['title'], ENT_QUOTES) ?>"
                                 data-authors="<?= htmlspecialchars($book['author'], ENT_QUOTES) ?>"
                                 data-thumbnail="<?= htmlspecialchars($book['imgUrl'], ENT_QUOTES) ?>"
                                 data-description="<?= htmlspecialchars($book['description'], ENT_QUOTES) ?>">
                             Add to Library
                         </button>
                         <span class="google-add-result ms-1"></span>
                     </div>
                 </div>
             </div>
         </div>
     <?php endforeach; ?>
 </div>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
 <script src="js/google_results.js"></script>
+<script src="js/pwa.js"></script>
 </body>
 </html>
diff --git a/icon-192.png b/icon-192.png
new file mode 100644
index 0000000000000000000000000000000000000000..20e9eef6c11a2001d7c2292f6406df49923b4ccd
GIT binary patch
literal 172
zcmeAS@N?(olHy`uVBq!ia0vp^2SAt+NHA0_4_pPL6p}rHe1SYQ28M<f28Lfip@tU>
z45bDP46hOx7_4S6Fo+k-*%fF5lweBoc6VW5yxS$b1ju7A@$_|Nf5|S-sie79WZnm$
zkea89V@Sl|w<i|@t>9r&_+KBT9}(B+Rn;Nj#G%*%A^scctbfmNu(W*vPzQsjtDnm{
Hr-UW|d5SGa

literal 0
HcmV?d00001

diff --git a/icon-512.png b/icon-512.png
new file mode 100644
index 0000000000000000000000000000000000000000..4208be4bb9cd805f0b3f0f563ceeba7715539649
GIT binary patch
literal 274
zcmeAS@N?(olHy`uVBq!ia0y~yU;;9k7#M*h!yV?A;Xq0u*(1o8fuTx`fuW&=f#DZW
zsNn?zL#Y7+!>a@a2CEqi4B`cIb_Lo1C76=D-CY<M?{*0<0rJ>OJbhi+U$V<{Drv42
znfC!G)Z^*m7*cWT?HNN}1_mDH1;5PicHP*@!ZJb5RY8D*g{jejUetqf1G8W4MZD9r
R&4BJ=@O1TaS?83{1OP;}Iw1f6

literal 0
HcmV?d00001

diff --git a/js/pwa.js b/js/pwa.js
new file mode 100644
index 0000000000000000000000000000000000000000..6683329271b8591ec7e6cac16c2dccab524c4435
--- /dev/null
+++ b/js/pwa.js
@@ -0,0 +1,7 @@
+if ('serviceWorker' in navigator) {
+  window.addEventListener('load', () => {
+    navigator.serviceWorker.register('/service-worker.js').catch(err => {
+      console.error('SW registration failed:', err);
+    });
+  });
+}
diff --git a/list_books.php b/list_books.php
index 6ea163af6a06ca1846f554ac94e3f944366f1267..f50effc9e963ca15b4e8ea11efd154bec621c595 100755
--- a/list_books.php
+++ b/list_books.php
@@ -532,50 +532,51 @@ function buildBaseUrl(array $params, array $exclude = []): string {
     }
 
     // Merge/override with custom params
     $params = array_merge($defaults, $params);
 
     // Filter empty values
     $query = array_filter($params, fn($v) => $v !== '' && $v !== null);
 
     return 'list_books.php?' . http_build_query($query);
 }
 
 function linkActive(string $current, string $compare): string {
     return $current === $compare ? ' active' : '';
 }
 
 function linkTextColor(string $current, string $compare): string {
     return $current === $compare ? ' text-white' : '';
 }
 
 ?>
 <!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">
+    <link rel="manifest" href="manifest.json">
     <title>Book List</title>
     <link id="themeStylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
     <script src="js/theme.js"></script>
     <script src="js/search.js"></script>
     <!-- Removed jQuery and jQuery UI -->
     <style>
         .title-col {
             max-width: 700px;
             word-break: break-word;
         }
         
 /* Modern full-width book blocks */
 [data-book-block-id] {
     background: var(--bs-card-bg);
     border-radius: 6px;
     border: 1px solid var(--bs-border-color);
     transition: box-shadow 0.2s ease-in-out, transform 0.1s ease-in-out;
     padding: 1rem;
     margin-bottom: 1rem;
 }
 
 /* Striped effect (theme aware) */
 [data-book-block-id]:nth-of-type(even) {
     background-color: var(--bs-gray-200);
@@ -813,28 +814,29 @@ function linkTextColor(string $current, string $compare): string {
 </div>
         </div>
 
     <!-- Google Books Metadata Modal -->
     <div class="modal fade" id="googleModal" tabindex="-1" aria-hidden="true">
       <div class="modal-dialog modal-lg">
         <div class="modal-content">
           <div class="modal-header">
             <h5 class="modal-title">Google Books Results</h5>
             <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
           </div>
           <div class="modal-body">
             <div id="googleResults">Loading...</div>
           </div>
         </div>
       </div>
     </div>
         </div>
     </div>
 </div>
     
     
     
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
 <script src="js/list_books.js"></script>
+<script src="js/pwa.js"></script>
 </body>
 </html>
 
diff --git a/login.php b/login.php
index 27aae878e9d54dc8cdd8763e0c0f78625d5977ae..ad77898faaebbffbd1fab78c495188d26f3fac4a 100644
--- a/login.php
+++ b/login.php
@@ -1,65 +1,67 @@
 <?php
 require_once 'db.php';
 
 $error = '';
 if ($_SERVER['REQUEST_METHOD'] === 'POST') {
     $username = trim($_POST['username'] ?? '');
     $password = trim($_POST['password'] ?? '');
     if (validateUser($username, $password)) {
         setcookie('user', $username, time() + 60 * 60 * 24 * 30);
         header('Location: list_books.php');
         exit;
     }
     $error = 'Invalid credentials';
 }
 ?>
 <!doctype html>
 <html lang="en">
 <head>
   <meta charset="utf-8">
+  <link rel="manifest" href="manifest.json">
   <title>Login</title>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
   <style>
     html, body {
       height: 100%;
       margin: 0;
       padding: 0;
     }
     body {
       background: url('libwall.jpg') no-repeat center center fixed;
       background-size: cover;
       display: flex;
       justify-content: center;
       align-items: center;
     }
     .login-container {
       background: rgba(255, 255, 255, 0.85);
       padding: 2rem;
       border-radius: 8px;
       box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
       width: 100%;
       max-width: 400px;
     }
   </style>
 </head>
 <body>
   <div class="login-container">
     <h1 class="mb-4 text-center">Login</h1>
     <?php if ($error): ?>
       <div class="alert alert-danger"><?php echo htmlspecialchars($error); ?></div>
     <?php endif; ?>
     <form method="post">
       <div class="mb-3">
         <label for="username" class="form-label">Username</label>
         <input type="text" id="username" name="username" class="form-control">
       </div>
       <div class="mb-3">
         <label for="password" class="form-label">Password</label>
         <input type="password" id="password" name="password" class="form-control">
       </div>
-      <button type="submit" class="btn btn-primary w-100">Login</button>
+  <button type="submit" class="btn btn-primary w-100">Login</button>
     </form>
   </div>
+  <script src="js/pwa.js"></script>
 </body>
 </html>
 
diff --git a/manifest.json b/manifest.json
new file mode 100644
index 0000000000000000000000000000000000000000..2557c640a004011038b83861537618abecf37c30
--- /dev/null
+++ b/manifest.json
@@ -0,0 +1,20 @@
+{
+  "name": "SQLite Books",
+  "short_name": "Books",
+  "start_url": "/login.php",
+  "display": "standalone",
+  "background_color": "#ffffff",
+  "theme_color": "#000000",
+  "icons": [
+    {
+      "src": "icon-192.png",
+      "sizes": "192x192",
+      "type": "image/png"
+    },
+    {
+      "src": "icon-512.png",
+      "sizes": "512x512",
+      "type": "image/png"
+    }
+  ]
+}
diff --git a/notepad.php b/notepad.php
index 627379dd2940e0f2e0561463041cc09539824855..4291945e3f37d0576dc12ae361f87dd7b5d654f7 100644
--- a/notepad.php
+++ b/notepad.php
@@ -37,50 +37,51 @@ if ($id > 0) {
     $title = '';
     $text  = '';
 } else {
     $notes = $pdo->query('SELECT id, title, time, last_edited FROM notepad ORDER BY last_edited DESC')->fetchAll(PDO::FETCH_ASSOC);
     try {
         $notesId  = ensureSingleValueColumn($pdo, '#notes', 'Notes');
         $valTable  = "custom_column_{$notesId}";
         $linkTable = "books_custom_column_{$notesId}_link";
         $bookNotes = $pdo->query(
             "SELECT b.id, b.title, v.value AS note
              FROM $linkTable l
              JOIN $valTable v ON l.value = v.id
              JOIN books b ON l.book = b.id
              ORDER BY b.title COLLATE NOCASE"
         )->fetchAll(PDO::FETCH_ASSOC);
     } catch (PDOException $e) {
         $bookNotes = [];
     }
 }
 ?>
 <!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">
+    <link rel="manifest" href="manifest.json">
     <title>Notepad</title>
     <link id="themeStylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
     <script src="js/theme.js"></script>
     <script src="node_modules/tinymce/tinymce.min.js" referrerpolicy="origin"></script>
 
 <style>
     /* Ensure TinyMCE doesn't leave an invisible gap before rendering */
     .tox-tinymce {
         visibility: visible !important;
         opacity: 1 !important;
         transition: none !important;
     }
 
     /* Optional: remove extra spacing if TinyMCE adds padding */
     .tox.tox-tinymce {
         margin-top: 0 !important;
     }
 
     </style>
 <?php if ($id > 0 || $action === 'new'): ?>
 <script>
 document.addEventListener('DOMContentLoaded', function () {
     if (typeof tinymce !== 'undefined') {
         tinymce.init({
@@ -191,27 +192,28 @@ document.addEventListener('DOMContentLoaded', function () {
     </div>
 
     <!-- Bootstrap JS -->
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
     <script>
     document.addEventListener('click', async ev => {
         const btn = ev.target.closest('.delete-note');
         if (!btn) return;
         if (!confirm('Are you sure you want to delete this note?')) return;
         const id = btn.dataset.noteId;
         try {
             const res = await fetch('delete_note.php', {
                 method: 'POST',
                 headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                 body: new URLSearchParams({ id })
             });
             const data = await res.json();
             if (data.status === 'ok') {
                 btn.closest('tr').remove();
             }
         } catch (err) {
             console.error(err);
         }
     });
     </script>
+<script src="js/pwa.js"></script>
 </body>
 </html>
\ No newline at end of file
diff --git a/notes.php b/notes.php
index 3b8c4b7c1937a68d7e171bc1db97037935b609ff..c4249dd4e458f1973ba6368c29cfa0ed6051cdf6 100644
--- a/notes.php
+++ b/notes.php
@@ -37,57 +37,59 @@ if ($_SERVER['REQUEST_METHOD'] === 'POST') {
 }
 
 // Fetch book title
 $stmt = $pdo->prepare('SELECT title FROM books WHERE id = ?');
 $stmt->execute([$bookId]);
 $bookTitle = $stmt->fetchColumn();
 if ($bookTitle === false) $bookTitle = '';
 
 // Fetch existing notes
 $notes = '';
 try {
     $notesId = ensureSingleValueColumn($pdo, '#notes', 'Notes');
     $valTable  = "custom_column_{$notesId}";
     $linkTable = "books_custom_column_{$notesId}_link";
     $noteStmt = $pdo->prepare("SELECT v.value FROM $linkTable l JOIN $valTable v ON l.value = v.id WHERE l.book = ?");
     $noteStmt->execute([$bookId]);
     $notes = $noteStmt->fetchColumn() ?: '';
 } catch (PDOException $e) {
     $notes = '';
 }
 ?>
 <!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
+    <link rel="manifest" href="manifest.json">
     <title>Edit Notes - <?= htmlspecialchars($bookTitle) ?></title>
     <link id="themeStylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
     <script src="js/theme.js"></script>
     <script src="node_modules/tinymce/tinymce.min.js" referrerpolicy="origin"></script>
     <script>
     tinymce.init({
         selector: '#notesEditor',
         license_key: 'gpl',
         promotion: false,
         branding: false,
         height: 600
     });
     </script>
 </head>
 <body class="pt-5">
 <?php include 'navbar_other.php'; ?>
 <div class="container my-4">
     <h1 class="mb-4">Edit Notes - <?= htmlspecialchars($bookTitle) ?></h1>
     <form method="post">
         <textarea id="notesEditor" name="notes" style="max-width:1000px;">
 <?= htmlspecialchars($notes) ?>
         </textarea>
         <div class="mt-3">
             <a href="book.php?id=<?= (int)$bookId ?>" class="btn btn-secondary me-2">Cancel</a>
             <button type="submit" class="btn btn-primary">Save</button>
         </div>
     </form>
 </div>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
+<script src="js/pwa.js"></script>
 </body>
 </html>
diff --git a/openlibrary_results.php b/openlibrary_results.php
index 127a5c43b91d09faf4329996a25118877d979418..17b26d7caf597e10b0d09ad9842d87038279f1af 100644
--- a/openlibrary_results.php
+++ b/openlibrary_results.php
@@ -5,50 +5,51 @@ require_once 'openlibrary.php';
 
 $search = isset($_GET['search']) ? trim((string)$_GET['search']) : '';
 $sort = $_GET['sort'] ?? 'author_series';
 $source = 'openlibrary';
 $books = [];
 if ($search !== '') {
     $books = search_openlibrary($search);
     // Fetch additional details like description for each work
     foreach ($books as &$b) {
         $b['description'] = '';
         if (!empty($b['key'])) {
             $work = get_openlibrary_work($b['key']);
             if (!empty($work['description'])) {
                 $b['description'] = $work['description'];
             }
         }
     }
     unset($b);
 }
 ?>
 <!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">
+    <link rel="manifest" href="manifest.json">
     <title>Open Library Results</title>
     <link id="themeStylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
     <script src="js/theme.js"></script>
     <script src="js/search.js"></script>
 </head>
 <body class="pt-5">
 <?php include "navbar_other.php"; ?>
 <div class="container my-4">
     <h1 class="mb-4">Open Library Results</h1>
     <table class="table table-striped">
         <thead>
             <tr>
                 <th>Cover</th>
                 <th class="title-col">Title</th>
                 <th>Author(s)</th>
                 <th>Actions</th>
             </tr>
         </thead>
         <tbody>
         <?php foreach ($books as $book): ?>
             <tr>
                 <td>
                     <?php if (!empty($book['cover_id'])): ?>
                         <img src="https://covers.openlibrary.org/b/id/<?= htmlspecialchars($book['cover_id']) ?>-S.jpg" alt="Cover" class="img-thumbnail" style="width: 150px; height: auto;">
                     <?php else: ?>
@@ -79,27 +80,28 @@ if ($search !== '') {
                             }
                             echo htmlspecialchars($display);
                         ?>
                     <?php else: ?>
                         &mdash;
                     <?php endif; ?>
                 </td>
                 <td>
                     <?php $coverUrl = !empty($book['cover_id']) ? 'https://covers.openlibrary.org/b/id/' . urlencode($book['cover_id']) . '-L.jpg' : ''; ?>
                     <button type="button" class="btn btn-sm btn-primary ol-add"
                             data-title="<?= htmlspecialchars($book['title'], ENT_QUOTES) ?>"
                             data-authors="<?= htmlspecialchars($book['authors'], ENT_QUOTES) ?>"
                             data-thumbnail="<?= htmlspecialchars($coverUrl, ENT_QUOTES) ?>"
                             data-description="<?= htmlspecialchars($book['description'], ENT_QUOTES) ?>">
                         Add to Library
                     </button>
                     <span class="ol-add-result ms-1"></span>
                 </td>
             </tr>
         <?php endforeach; ?>
         </tbody>
     </table>
 </div>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
 <script src="js/openlibrary_results.js"></script>
+<script src="js/pwa.js"></script>
 </body>
 </html>
diff --git a/openlibrary_view.php b/openlibrary_view.php
index 8c4f926a8ffc40670d64760d5b4b02b3800bfeab..43d8c918206eb6db9987f3c9d085f57f4883957e 100755
--- a/openlibrary_view.php
+++ b/openlibrary_view.php
@@ -3,66 +3,68 @@ require_once 'db.php';
 require_once 'openlibrary.php';
 
 $key = isset($_GET['key']) ? trim((string)$_GET['key']) : '';
 $title = isset($_GET['title']) ? (string)$_GET['title'] : '';
 $authors = isset($_GET['authors']) ? (string)$_GET['authors'] : '';
 $coverId = isset($_GET['cover_id']) ? (string)$_GET['cover_id'] : '';
 
 $work = [];
 if ($key !== '') {
     $work = get_openlibrary_work($key);
 }
 
 $workTitle = $work['title'] ?? $title;
 $description = $work['description'] ?? '';
 $subjects = $work['subjects'] ?? [];
 $covers = $work['covers'] ?? [];
 if (!$coverId && !empty($covers)) {
     $coverId = (string)($covers[0]);
 }
 ?>
 <!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">
+    <link rel="manifest" href="manifest.json">
     <title><?= htmlspecialchars($workTitle) ?></title>
     <link id="themeStylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
     <script src="js/theme.js"></script>
 </head>
 <body>
 <?php include "navbar_other.php"; ?>
 <div class="container my-4">
     <a href="javascript:history.back()" class="btn btn-secondary mb-3">Back</a>
     <h1 class="mb-4"><?= htmlspecialchars($workTitle) ?></h1>
     <div class="row mb-4">
         <div class="col-md-3">
             <?php if ($coverId): ?>
                 <img src="https://covers.openlibrary.org/b/id/<?= htmlspecialchars($coverId) ?>-L.jpg" class="img-fluid" alt="Cover">
             <?php endif; ?>
         </div>
         <div class="col-md-9">
             <?php if ($authors !== ''): ?>
                 <p><strong>Author(s):</strong> <?= htmlspecialchars($authors) ?></p>
             <?php endif; ?>
             <?php if ($description !== ''): ?>
                 <p><?= nl2br(htmlspecialchars($description)) ?></p>
             <?php endif; ?>
             <?php if (!empty($subjects)): ?>
                 <p><strong>Subjects:</strong> <?= htmlspecialchars(implode(', ', $subjects)) ?></p>
             <?php endif; ?>
             <?php $coverUrl = $coverId ? 'https://covers.openlibrary.org/b/id/' . urlencode($coverId) . '-L.jpg' : ''; ?>
             <button id="addBtn" type="button" class="btn btn-primary mt-3"
                     data-title="<?= htmlspecialchars($workTitle, ENT_QUOTES) ?>"
                     data-authors="<?= htmlspecialchars($authors, ENT_QUOTES) ?>"
                     data-thumbnail="<?= htmlspecialchars($coverUrl, ENT_QUOTES) ?>"
                     data-description="<?= htmlspecialchars($description, ENT_QUOTES) ?>">
                 Add to Library
             </button>
             <div id="addResult" class="mt-2"></div>
         </div>
     </div>
 </div>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
 <script src="js/openlibrary_view.js"></script>
+<script src="js/pwa.js"></script>
 </body>
 </html>
diff --git a/preferences.php b/preferences.php
index 837f74dd41b5c1ae2c066e0c7a0691012ece2101..c855f0b90cf36a42f9e347d3e468d96df404464b 100755
--- a/preferences.php
+++ b/preferences.php
@@ -24,59 +24,61 @@ if ($_SERVER['REQUEST_METHOD'] === 'POST') {
 
     $dbWritable = $dbPath === '' ? true : (file_exists($dbPath)
         ? is_writable($dbPath)
         : (is_dir(dirname($dbPath)) && is_writable(dirname($dbPath))));
     $libWritable = $libPath === '' ? true : (is_dir($libPath) && is_writable($libPath));
 
     if ($dbWritable && $libWritable) {
         $message = 'Preferences saved.';
     } else {
         $alertClass = 'danger';
         if (!$dbWritable) {
             $message = 'Database path is not writable.';
         } elseif (!$libWritable) {
             $message = 'Library path is not writable.';
         }
     }
 }
 
 $currentPath = currentDatabasePath();
 $currentLibrary = getLibraryPath();
 ?>
 <!doctype html>
 <html lang="en">
 <head>
   <meta charset="utf-8">
+  <link rel="manifest" href="manifest.json">
   <title>Preferences</title>
   <link id="themeStylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
   <script src="js/theme.js"></script>
 </head>
 <body class="container py-4">
   <h1 class="mb-4">Preferences</h1>
   <?php if ($message): ?>
     <div class="alert alert-<?php echo $alertClass; ?>"><?php echo htmlspecialchars($message); ?></div>
   <?php endif; ?>
   <form method="post">
   <div class="mb-3">
     <label for="db_path" class="form-label">Calibre database path</label>
     <input type="text" id="db_path" name="db_path" class="form-control" value="<?php echo htmlspecialchars($currentPath); ?>">
   </div>
   <div class="mb-3">
     <label for="library_path" class="form-label">Calibre library path</label>
     <input type="text" id="library_path" name="library_path" class="form-control" value="<?php echo htmlspecialchars($currentLibrary); ?>">
   </div>
   <div class="mb-3">
     <label for="themeSelect" class="form-label">Theme</label>
     <select id="themeSelect" class="form-select" style="max-width: 20rem;"></select>
     <div class="form-text">Saved locally in this browser</div>
   </div>
   <div class="form-check mb-3">
     <input class="form-check-input" type="checkbox" value="1" id="save_global" name="save_global">
     <label class="form-check-label" for="save_global">
       Save as default for all users
       </label>
     </div>
     <button type="submit" class="btn btn-primary">Save</button>
     <a href="fix_author_sort.php" class="btn btn-secondary ms-2">Fix Author Sort</a>
   </form>
+  <script src="js/pwa.js"></script>
 </body>
 </html>
diff --git a/reading_challenges.php b/reading_challenges.php
index 8fd53342f40250d434081e72dfe272ae04324a7a..7664f8fdf74a00779dba604ff46ddbd266b85feb 100755
--- a/reading_challenges.php
+++ b/reading_challenges.php
@@ -87,50 +87,51 @@ try {
     die('Database error: ' . $e->getMessage());
 }
 ?>
 
 
 <?php if ($goal): ?>
     <?php 
         $percent = min(100, (int)(($readCount / $goal) * 100));
         $milestones = [25, 50, 75, 100];
         $nextMilestone = null;
         foreach ($milestones as $m) {
             if ($percent < $m) { 
                 $nextMilestone = $m; 
                 break; 
             }
         }
         $booksForNextMilestone = $nextMilestone ? ceil(($nextMilestone * $goal / 100) - $readCount) : 0;
     ?>
 
 
 <!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">
+    <link rel="manifest" href="manifest.json">
     <title>Reading Challenge</title>
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
     <link id="themeStylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
     <script src="js/theme.js"></script>
 </head>
 <body class="pt-5">
 <?php include "navbar_other.php"; ?>
 <div class="container my-4">
     <h1 class="mb-4 d-flex align-items-center">
         <i class="fa-solid fa-flag-checkered me-2 text-success"></i> 
         Reading Challenge <?= htmlspecialchars((string)$year) ?>
     </h1>
     
     <?php if ($message): ?>
         <div class="alert alert-success">
             <i class="fa-solid fa-circle-check me-2"></i> 
             <?= htmlspecialchars($message) ?>
         </div>
     <?php endif; ?>
 
     <div class="card mb-4 shadow-sm">
         <div class="card-body">
             <h5 class="card-title">
                 <i class="fa-solid fa-book me-2"></i>
                 You have read <strong><?= $readCount ?></strong><?= $goal ? " of <strong>{$goal}</strong>" : '' ?> books this year.
@@ -260,27 +261,28 @@ try {
                             <h5 class="card-title"><?= htmlspecialchars($b['title']) ?></h5>
                             <p class="text-muted mb-2"><?= htmlspecialchars($b['authors']) ?></p>
                             <?php if (!empty($b['read_date'])): ?>
                                 <p class="small text-success mb-2">
                                     <i class="fa-solid fa-check me-1"></i>
                                     Finished: <?= htmlspecialchars(date('M j, Y', strtotime($b['read_date']))) ?>
                                 </p>
                             <?php endif; ?>
                             <div class="mt-auto">
                                 <a href="book.php?id=<?= urlencode($b['id']) ?>" class="btn btn-outline-primary btn-sm me-2">
                                     <i class="fa-solid fa-eye"></i> View
                                 </a>
                                 <button class="btn btn-sm btn-danger remove-challenge" data-book-id="<?= htmlspecialchars($b['id']) ?>">
                                     <i class="fa-solid fa-trash"></i> Remove
                                 </button>
                             </div>
                         </div>
                     </div>
                 </div>
             <?php endforeach; ?>
         </div>
     <?php endif; ?>
 </div>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
 <script src="js/reading_challenges.js"></script>
+<script src="js/pwa.js"></script>
 </body>
 </html>
diff --git a/service-worker.js b/service-worker.js
new file mode 100644
index 0000000000000000000000000000000000000000..373c7ad8730009de15eb8c4e8156a4227ea8a53d
--- /dev/null
+++ b/service-worker.js
@@ -0,0 +1,23 @@
+const CACHE_NAME = 'sqlite-books-v1';
+const OFFLINE_URLS = [
+  '/',
+  '/login.php',
+  '/list_books.php',
+  '/manifest.json',
+  '/icon-192.png',
+  '/icon-512.png'
+];
+
+self.addEventListener('install', event => {
+  event.waitUntil(
+    caches.open(CACHE_NAME).then(cache => cache.addAll(OFFLINE_URLS))
+  );
+});
+
+self.addEventListener('fetch', event => {
+  event.respondWith(
+    caches.match(event.request).then(response => {
+      return response || fetch(event.request);
+    })
+  );
+});
diff --git a/upload_book_file.php b/upload_book_file.php
index 5ab011d4600601f1387e641dd8cd7a177c1db75c..d7d56f5c78116832a9ce75911e558b29afd71d0d 100644
--- a/upload_book_file.php
+++ b/upload_book_file.php
@@ -98,51 +98,53 @@ if ($_SERVER['REQUEST_METHOD'] === 'POST') {
             $pdo->commit();
             $message = 'File uploaded successfully.';
         } catch (Exception $e) {
             $pdo->rollBack();
             $errors[] = $e->getMessage();
         }
     }
 
     if ($wantJson) {
         header('Content-Type: application/json');
         if ($errors) {
             http_response_code(400);
             echo json_encode(['error' => implode(' ', $errors)]);
         } else {
             echo json_encode(['status' => 'ok', 'message' => $message]);
         }
         exit;
     }
 }
 ?>
 <!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">
+    <link rel="manifest" href="manifest.json">
     <title>Upload File</title>
     <link id="themeStylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
     <script src="js/theme.js"></script>
 </head>
 <body>
 <?php include 'navbar_other.php'; ?>
 <div class="container my-4">
     <h1 class="mb-4">Upload File for <?= htmlspecialchars($book['title']) ?></h1>
     <?php if ($message): ?>
         <div class="alert alert-success"><?= htmlspecialchars($message) ?></div>
     <?php elseif ($errors): ?>
         <div class="alert alert-danger"><?= htmlspecialchars(implode(' ', $errors)) ?></div>
     <?php endif; ?>
     <form method="post" enctype="multipart/form-data">
         <input type="hidden" name="id" value="<?= htmlspecialchars($bookId) ?>">
         <div class="mb-3">
             <label for="file" class="form-label">Book File</label>
             <input type="file" name="file" id="file" class="form-control" required>
         </div>
         <button type="submit" class="btn btn-primary">Upload</button>
         <a href="book.php?id=<?= urlencode($bookId) ?>" class="btn btn-secondary ms-2">Back</a>
     </form>
 </div>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
+<script src="js/pwa.js"></script>
 </body>
 </html>

